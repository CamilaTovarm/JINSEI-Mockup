<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jinsei Life Support Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', Arial, sans-serif;
            background: radial-gradient(circle at 30% 30%, #f4ebea 0%, #c8e0d2 48%, #85c5a0 100%);
            margin:0;
            padding:0;
        }
        .container {
            width:100vw;
            height:100vh;
            display:flex;
        }
        .sidebar {
            background: linear-gradient(180deg, #e5f5fa 60%, #b0cbc3 100%);
            padding:60px 35px;
            width:36vw;
            min-width:320px;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            box-shadow:0 2px 12px #b5c7bb50;
            border-radius:0 40px 40px 0;
        }
        .sidebar img {
            width:180px;
            height:auto;
            margin-bottom:18px;
            border-radius:40px;
            box-shadow:0 4px 32px #b5c7bb30;
            background:#e9f3ec;
        }
        .bot-name {
            font-size:2.2rem;
            font-weight:700;
            color:#28538C;
            margin:8px 0;
            letter-spacing:1px;
        }
        .tagline {
            font-size:1.2rem;
            color:#5fa5b6;
            font-weight:500;
            margin-bottom:16px;
        }
        .quote {
            font-size:1.13rem;
            color:#47775a;
            text-align: center;
            margin-top:10px;
        }

        .chat-area {
            flex:1;
            display:flex;
            flex-direction:column;
            background:linear-gradient(120deg,#eafaf8 50%,#e3e9f4 110%);
            border-radius:40px 0 0 0;
            box-shadow:0 2px 14px #e6eaf022;
        }

        .chat-header {
            background:#5fa5b6;
            color:#fff;
            padding:18px 32px;
            border-radius:0 0 14px 14px;
            font-weight:600;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:10px;
            letter-spacing:1px;
            font-size:1.08rem;
        }
        
        .chat-header-left {
            display:flex;
            align-items:center;
            gap:10px;
        }
        
        .logout-btn {
            background:#8b5fb6;
            color:#fff;
            border:none;
            padding:8px 18px;
            font-size:0.95rem;
            border-radius:10px;
            font-weight:600;
            cursor:pointer;
            transition: all 0.3s ease;
            box-shadow:0 2px 8px rgba(139, 95, 182, 0.3);
        }
        
        .logout-btn:hover {
            background:#7a4fa5;
            transform:translateY(-2px);
            box-shadow:0 4px 12px rgba(139, 95, 182, 0.4);
        }
        
        .logout-btn:active {
            transform:translateY(0);
        }
        
        .chat-messages {
            flex:1;
            padding:34px;
            overflow-y:auto;
            display:flex;
            flex-direction:column;
            gap:23px;
        }
        .chat-message {
            display:flex;
            align-items:flex-start;
            gap:11px;
        }
        .bot-avatar, .user-avatar {
            background:#b0cbc3;
            border-radius:50%;
            width:39px;
            height:39px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:2rem;
            box-shadow:0 1px 5px #b5c7bb55;
        }
        .user-avatar {
            background:#ffe4b8;
        }
        .chat-bubble {
            background: #fff;
            padding:14px 18px;
            border-radius:15px;
            box-shadow:0 2px 12px #b5c7bb22;
            font-size:1.16rem;
            color:#28538C;
            max-width:380px;
        }
        .user-bubble {
            background: #e3e9f4;
            text-align:right;
            align-self:flex-end;
        }
        .chat-input-bar {
            display:flex;
            padding:22px 38px;
            gap:12px;
            background:#f6fafb;
            border-top:1px solid #d0e8d6;
        }
        .chat-input {
            flex:1;
            padding:10px 18px;
            border-radius:9px;
            border:1px solid #c8e0d2;
            outline:none;
            font-size:1rem;
            background:#fff;
            box-shadow:0 1px 4px #e9edf522;
            color:#47775a;
        }
        .chat-send {
            background:#28538C;
            color:#fff;
            border:none;
            padding:9px 22px;
            font-size:1.09rem;
            border-radius:12px;
            font-weight:600;
            cursor:pointer;
            transition: background 0.17s;
        }
        .chat-send:hover { background:#377e63; }

        /* ALERTA */
        .alerta-alta {
            background:#ffb3b3;
            border-left:6px solid red;
            padding:16px;
            border-radius:10px;
            color:#a10000;
            font-weight:700;
            font-size:1.15rem;
            max-width:380px;
        }
        .boton-ayuda {
            background:red;
            color:white;
            padding:10px 18px;
            border-radius:10px;
            border:none;
            cursor:pointer;
            margin-top:8px;
            font-weight:700;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="sidebar">  
        <img src="/assets/iconapp.png" alt="Logo Jinsei" />
        <div class="bot-name">JINSEI</div>
        <div class="tagline">LIFE SUPPORT CHAT</div>
        <div class="quote">"Cada dÃ­a es una nueva oportunidad para empezar de nuevo ðŸ§¡ðŸ’™"</div>
    </div>
    <div class="chat-area">
        <div class="chat-header">
            <div class="chat-header-left">
                ðŸ’¬ Chat con Jinsei
            </div>
            <button id="logout-btn" class="logout-btn">ðŸšª Cerrar SesiÃ³n</button>
        </div>
        <div id="chat-box" class="chat-messages"></div>
        <div class="chat-input-bar">
            <input id="mensaje" type="text" class="chat-input" placeholder="Escribe tu mensaje..." />
            <button id="send-btn" class="chat-send">Enviar</button>
        </div>   
    </div>
</div>

<script>
const BERT_URL = "https://ciara-disillusive-unobservantly.ngrok-free.dev/predict";
const MISTRAL_URL = "https://tackier-hebetic-jong.ngrok-free.dev/generar_respuesta";
const API_URL = "https://jinsei-app-hjg9h0bqa7g5bhfh.canadacentral-01.azurewebsites.net/api";

const user_id = Number(localStorage.getItem("user_id"));
const session_id = Number(localStorage.getItem("session_id"));

// ProtecciÃ³n: verificar sesiÃ³n vÃ¡lida al cargar la pÃ¡gina
if (!user_id || !session_id) {
    console.warn("No hay sesiÃ³n activa. Redirigiendo al login...");
    localStorage.clear();
    window.location.replace("index.html");
}

// Bloquear navegaciÃ³n hacia atrÃ¡s
(function() {
    // Crear mÃºltiples entradas en el historial
    for (let i = 0; i < 10; i++) {
        history.pushState(null, null, location.href);
    }
    
    window.addEventListener('popstate', function() {
        history.pushState(null, null, location.href);
    });
    
    // Prevenir navegaciÃ³n con teclas
    window.addEventListener('keydown', function(e) {
        // Backspace fuera de inputs
        if (e.keyCode === 8 && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
            e.preventDefault();
        }
        // Alt + Left Arrow (AtrÃ¡s)
        if (e.altKey && e.keyCode === 37) {
            e.preventDefault();
        }
        // Alt + Right Arrow (Adelante)
        if (e.altKey && e.keyCode === 39) {
            e.preventDefault();
        }
    });
})();

// FunciÃ³n para cerrar sesiÃ³n
async function cerrarSesion() {
    if (!session_id) {
        console.error("No hay session_id para cerrar.");
        localStorage.clear();
        window.location.replace("index.html");
        return;
    }

    try {
        const response = await fetch(`${API_URL}/sessions/${session_id}/end`, {
            method: "POST",
            headers: { "Content-Type": "application/json" }
        });

        const data = await response.json();
        
        if (response.ok && data.success) {
            console.log("SesiÃ³n cerrada exitosamente.");
        } else {
            console.error("Error al cerrar sesiÃ³n:", data.message);
        }
    } catch (error) {
        console.error("Error al cerrar sesiÃ³n:", error);
    } finally {
        // Limpiar localStorage y redirigir sin historial
        localStorage.removeItem("user_id");
        localStorage.removeItem("session_id");
        localStorage.removeItem("aka");
        window.location.replace("index.html");
    }
}

// Event listener para el botÃ³n de logout
document.getElementById("logout-btn").addEventListener("click", cerrarSesion);

function agregarMensaje(texto, tipo, esAlerta=false) {
    const box = document.getElementById("chat-box");
    const cont = document.createElement("div");
    cont.className = "chat-message";

    if (tipo === "user") {
        cont.style.justifyContent = "flex-end";
        cont.innerHTML = `<div class="chat-bubble user-bubble">${texto}</div><div class="user-avatar">ðŸ§‘</div>`;
    } else {
        if (esAlerta) {
            cont.innerHTML = `
                <div class="bot-avatar">âš </div>
                <div>
                    <div class="alerta-alta">${texto}</div>
                    <button class="boton-ayuda" onclick="location.href='formulario.html'">SI QUIERO AYUDA</button>
                </div>
            `;
        } else {
            cont.innerHTML = `<div class="bot-avatar">ðŸ¤–</div><div class="chat-bubble">${texto}</div>`;
        }
    }

    box.appendChild(cont);
    box.scrollTop = box.scrollHeight;
}

function obtenerEtiqueta(riesgo) {
    if (riesgo < 20) return "sin_riesgo";
    if (riesgo < 50) return "riesgo_bajo";
    return "riesgo_alto";
}

async function enviarMensaje(msg) {
    agregarMensaje(msg, "user");

    try {
        // 1) BERT
        const bertRes = await fetch(BERT_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ texto: msg }) });
        const bertData = await bertRes.json();
        const riesgo = bertData?.porcentajes?.riesgo ?? 0;
        const etiqueta = obtenerEtiqueta(riesgo);

        // 2) Mistral
        const mistralRes = await fetch(MISTRAL_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ mensaje: msg, session_id, nivel_riesgo: etiqueta, historial: [] })
        });
        const data = await mistralRes.json();
        const botResp = data.respuesta || "Error en Mistral.";

        // 3) Guardar mensaje en BD
        await fetch(`${API_URL}/messages`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                user_id,
                user_response: msg,
                bot_message: botResp,
                risk_percent: riesgo
            })
        });

        // 4) Mostrar mensaje normal
        agregarMensaje(botResp, "bot");

        // 5) Si es riesgo alto, mostrar alerta con mensaje **diferente**
        if (etiqueta === "riesgo_alto") {
            agregarMensaje(
                "Detectamos seÃ±ales de riesgo. No estÃ¡s solo. Â¿Quieres recibir ayuda profesional?",
                "bot",
                true
            );
        }

    } catch (err) {
        agregarMensaje("âš  Error comunicÃ¡ndose con los servidores.", "bot");
        console.error(err);
    }
}

// FunciÃ³n para enviar mensaje
function enviarMensajeInput() {
    const msg = document.getElementById("mensaje").value.trim();
    if (!msg) return;
    document.getElementById("mensaje").value = "";
    enviarMensaje(msg);
}

// Event listener para el botÃ³n de enviar
document.getElementById("send-btn").onclick = enviarMensajeInput;

// Event listener para la tecla Enter
document.getElementById("mensaje").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
        e.preventDefault();
        enviarMensajeInput();
    }
});

// Evento al cerrar la pestaÃ±a/navegador
window.addEventListener("beforeunload", (e) => {
    if (!session_id) return;
    
    // Usar sendBeacon para asegurar que la peticiÃ³n se envÃ­e antes de cerrar
    const data = JSON.stringify({});
    navigator.sendBeacon(`${API_URL}/sessions/${session_id}/end`, data);
    
    // Limpiar localStorage
    localStorage.removeItem("user_id");
    localStorage.removeItem("session_id");
    localStorage.removeItem("aka");
    
    console.log("SesiÃ³n cerrada al salir de la pÃ¡gina.");
});

// Evento alternativo para navegadores que no soportan beforeunload correctamente
window.addEventListener("unload", () => {
    if (!session_id) return;
    
    // Intento adicional con sendBeacon
    navigator.sendBeacon(`${API_URL}/sessions/${session_id}/end`, JSON.stringify({}));
});
</script>
</body>
</html>       
